<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evidence aktiv - MěÚ Vítkov</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Firebase App (Core) SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <!-- Firebase Authentication SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-auth.js"></script>
    <!-- Firebase Realtime Database SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        .sidebar-item { cursor: pointer; transition: background-color 0.2s ease-in-out; }
        .sidebar-item:hover { background-color: #e5e7eb; }
        .sidebar-item.active { background-color: #d1d5db; font-weight: 600; }
        .asset-link { color: #2563eb; text-decoration: underline; cursor: pointer; }
        .asset-link:hover { color: #1d4ed8; }
        .details-grid { display: grid; grid-template-columns: auto 1fr; gap: 1rem 2rem; align-items: start; }
        .details-grid > dt { font-weight: 600; color: #4b5563; }
        .details-grid > dd { color: #1f2937; }
        .edit-form-grid { display: grid; grid-template-columns: 1fr 2fr; gap: 1rem 2rem; align-items: start; }
        .edit-form-grid label { font-weight: 600; color: #4b5563; padding-top: 0.5rem; }
        .form-input { width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem; }
        .changed-value { color: #dc2626; font-weight: bold; transition: color 0.3s ease-in-out; }
        .selected-item-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            margin: 0.25rem;
            background-color: #e0e7ff;
            color: #4338ca;
            border-radius: 9999px;
            font-size: 0.875rem;
        }
        .selected-item-badge button {
            margin-left: 0.5rem;
            color: #9ca3af;
        }
        .selected-item-badge button:hover {
            color: #374151;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Login Screen -->
    <div id="login-screen" class="flex items-center justify-center h-screen bg-gray-200">
        <div class="w-full max-w-md p-8 space-y-6 bg-white rounded-lg shadow-md">
            <h2 class="text-2xl font-bold text-center text-gray-700">Přihlášení do Evidence aktiv</h2>
            <form id="login-form" class="space-y-6">
                <div>
                    <label for="email" class="text-sm font-medium text-gray-700">E-mail</label>
                    <input id="email" name="email" type="email" required class="form-input mt-1" placeholder="jmeno.prijmeni@mesto.cz">
                </div>
                <div>
                    <label for="password" class="text-sm font-medium text-gray-700">Heslo</label>
                    <input id="password" name="password" type="password" required class="form-input mt-1" placeholder="••••••••">
                </div>
                <p id="login-error" class="text-sm text-red-600"></p>
                <button type="submit" class="w-full px-4 py-2 text-white bg-blue-600 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    Přihlásit se
                </button>
            </form>
        </div>
    </div>

    <!-- Main App Container (hidden by default) -->
    <div id="app-container" class="hidden flex-col h-screen">
        <header class="bg-white shadow-md w-full p-4 flex justify-between items-center">
            <h1 class="text-2xl font-bold text-gray-700">Evidence aktiv Městského úřadu Vítkov</h1>
            <div>
                <span id="user-info" class="text-sm text-gray-600 mr-4"></span>
                <button id="logout-button" class="px-4 py-2 text-sm text-white bg-red-600 rounded-md hover:bg-red-700">Odhlásit se</button>
            </div>
        </header>
        <div class="flex flex-1 overflow-hidden">
            <nav id="sidebar" class="w-1/3 lg:w-1/4 bg-white border-r border-gray-200 overflow-y-auto p-4"></nav>
            <main id="content" class="flex-1 p-6 overflow-y-auto">
                 <div class="bg-white p-4 rounded-lg shadow-md mb-6">
                    <dl class="details-grid">
                        <dt>Správce:</dt>
                        <dd>Město Vítkov, náměstí Jana Zajíce 7, 749 01 Vítkov, IČO: 00300870</dd>
                        <dt>Pověřenec:</dt>
                        <dd>Mgr. Jiří Jarema, poverenec.vitkov@outlook.cz, tel.: 775 248 345</dd>
                    </dl>
                </div>
                <div id="welcome-message" class="text-center text-gray-500">
                    <h2 class="text-2xl font-semibold mb-2">Vítejte v evidenci aktiv</h2>
                    <p>Vyberte položku z menu vlevo pro zobrazení detailů.</p>
                </div>
                <div id="asset-detail" class="hidden"></div>
            </main>
        </div>
    </div>

    <script>
        // Vaše Firebase konfigurace
        const firebaseConfig = {
            apiKey: "AIzaSyBcoossk-fHBUrNd3x2Dd3bS-auCcvgwEk",
            authDomain: "aktiva-vitkov.firebaseapp.com",
            databaseURL: "https://aktiva-vitkov-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "aktiva-vitkov",
            storageBucket: "aktiva-vitkov.appspot.com",
            messagingSenderId: "6167416010",
            appId: "1:6167416010:web:ba5cca4eb0aa0eac343833"
        };

        // Inicializace Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();

        // Globální proměnné pro stav aplikace
        let currentUser = null;
        let userRole = null;
        let userOdbor = null;
        let assetData = {};
        let sharedOptions = {};
        let allAssets = {};
        let parentMap = {};

        // Elementy DOM
        const loginScreen = document.getElementById('login-screen');
        const appContainer = document.getElementById('app-container');
        const loginForm = document.getElementById('login-form');
        const loginError = document.getElementById('login-error');
        const logoutButton = document.getElementById('logout-button');
        const userInfo = document.getElementById('user-info');
        const sidebar = document.getElementById('sidebar');
        const assetDetailContainer = document.getElementById('asset-detail');
        const welcomeMessage = document.getElementById('welcome-message');

        const detailOrder = [
            "Garant", "Účel zpracování", "Zákonnost zpracování", "Legislativa", "Způsob zpracování",
            "Zdroje osobních údajů", "Kategorie osobních údajů", "Zvláštní kategorie osobních údajů",
            "Lhůty pro výmaz", "Zpracovatel", "Jmenný seznam oprávněných osob",
            "Kategorie příjemců osobních údajů", "Propojení na jiné správce nebo zpracovatele",
            "Předávání osobních údajů do třetí země", "Zabezpečení zpracování - elektronické",
            "Zabezpečení zpracování - analogové"
        ];
        
        const reciprocalMap = {
            'podpurna/children/databaze': {
                'Agendy_uzivajici_DB': {
                    targetCategoryPath: 'primarni/children/informacni-systemy',
                    reciprocalField: 'Databáze'
                }
            },
            'podpurna/children/servery': {
                'Provozovane_databaze': {
                    targetCategoryPath: 'podpurna/children/databaze',
                    reciprocalField: 'Server'
                },
                'Provozovane_aplikace': {
                    targetCategoryPath: 'primarni/children/informacni-systemy',
                    reciprocalField: 'Aplikační_server'
                }
            },
            'primarni/children/informacni-systemy': {
                'Databáze': {
                    targetCategoryPath: 'podpurna/children/databaze',
                    reciprocalField: 'Agendy_uzivajici_DB'
                },
                'Aplikační_server': {
                    targetCategoryPath: 'podpurna/children/servery',
                    reciprocalField: 'Provozovane_aplikace'
                }
            }
        };

        // --- AUTHENTICATION LOGIC ---

        auth.onAuthStateChanged(async (user) => {
            if (user) {
                currentUser = user;
                const userRef = db.ref(`users/${user.uid}`);
                const snapshot = await userRef.once('value');
                const userData = snapshot.val();
                
                if (userData && userData.role) {
                    userRole = userData.role;
                    userOdbor = userData.odbor || null;
                    userInfo.textContent = `${user.email} (role: ${userRole})`;
                    
                    loginScreen.classList.add('hidden');
                    appContainer.classList.remove('hidden');
                    appContainer.classList.add('flex');
                    
                    await loadInitialData();
                } else {
                    loginError.textContent = 'Pro váš účet nejsou nastavena oprávnění.';
                    auth.signOut();
                }
            } else {
                currentUser = null;
                userRole = null;
                userOdbor = null;
                loginScreen.classList.remove('hidden');
                appContainer.classList.add('hidden');
                appContainer.classList.remove('flex');
            }
        });

        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            loginError.textContent = '';
            const email = loginForm.email.value;
            const password = loginForm.password.value;

            auth.signInWithEmailAndPassword(email, password)
                .catch((error) => {
                    console.error("Chyba přihlášení:", error);
                    loginError.textContent = 'Nesprávné jméno nebo heslo.';
                });
        });

        logoutButton.addEventListener('click', () => {
            auth.signOut();
        });

        // --- APPLICATION LOGIC ---

        function sanitizeForId(text) {
            return text.replace(/[^a-zA-Z0-9-_]/g, '_');
        }

        function flattenData(data) {
            let flat = {};
            for (const key in data) {
                flat[key] = data[key];
                if (data[key].children) {
                    Object.assign(flat, flattenData(data[key].children));
                }
            }
            return flat;
        }

        function buildParentMap(data, parent = null) {
            for (const key in data) {
                parentMap[key] = parent;
                if (data[key].children) {
                    buildParentMap(data[key].children, key);
                }
            }
        }

        function findParentId(childId) {
            return parentMap[childId];
        }

        function getPathForAsset(assetId) {
            let path = [];
            let currentId = assetId;
            while(currentId) {
                path.unshift(currentId);
                currentId = findParentId(currentId);
            }
            return path.join('/children/');
        }

        function getObjectByPath(obj, path) {
            return path.split('/').reduce((acc, part) => {
                if (part === 'children') {
                    return acc ? acc.children : null;
                }
                return acc ? acc[part] : null;
            }, obj);
        }

        function buildNav(data, parentElement, level = 0) {
            if (level >= 2) return;
            const ul = document.createElement('ul');
            if (level > 0) ul.style.paddingLeft = `${(level-1) * 16}px`;
            
            for (const key in data) {
                const item = data[key];
                const li = document.createElement('li');
                const itemDiv = document.createElement('div');
                itemDiv.textContent = item.name;
                itemDiv.dataset.id = key;
                itemDiv.className = level === 0 ? 'font-bold text-lg mt-4 cursor-default' : 'p-2 rounded-md sidebar-item';
                if (level > 0) itemDiv.onclick = () => showCategoryContent(key);
                
                li.appendChild(itemDiv);
                if (item.children) buildNav(item.children, li, level + 1);
                ul.appendChild(li);
            }
            parentElement.appendChild(ul);
        }

        function showCategoryContent(categoryId) {
            const asset = allAssets[categoryId];
            if (!asset || !asset.children) return;
            welcomeMessage.classList.add('hidden');
            assetDetailContainer.classList.remove('hidden');
            assetDetailContainer.innerHTML = '';
            document.querySelectorAll('.sidebar-item.active').forEach(el => el.classList.remove('active'));
            document.querySelector(`.sidebar-item[data-id="${categoryId}"]`)?.classList.add('active');

            const titleContainer = document.createElement('div');
            titleContainer.className = 'flex justify-between items-center border-b border-gray-300 mb-6 pb-2';

            const title = document.createElement('h2');
            title.textContent = asset.name;
            title.className = 'text-3xl font-bold';
            titleContainer.appendChild(title);

            const parentId = findParentId(categoryId);
            if (parentId === 'agendy' && (userRole === 'administrator' || (userRole === 'garant' && userOdbor === categoryId))) {
                const addButton = document.createElement('button');
                addButton.textContent = 'Přidat novou agendu';
                addButton.className = 'px-4 py-2 bg-green-500 text-white rounded-md hover:bg-green-600';
                addButton.onclick = () => renderNewAgendaForm(categoryId);
                titleContainer.appendChild(addButton);
            }
            assetDetailContainer.appendChild(titleContainer);

            const listContainer = document.createElement('div');
            listContainer.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4';
            for(const childId in asset.children){
                const childAsset = asset.children[childId];
                const card = document.createElement('div');
                card.className = 'bg-white p-4 rounded-lg shadow hover:shadow-lg transition-shadow cursor-pointer border border-gray-200';
                card.innerHTML = `<h3 class="font-semibold text-lg text-blue-600">${childAsset.name}</h3>`;
                card.onclick = () => showAssetDetails(childId, categoryId);
                listContainer.appendChild(card);
            }
            assetDetailContainer.appendChild(listContainer);
        }
        
        function createLinksFragment(linksTo) {
            const fragment = document.createDocumentFragment();
            const links = Array.isArray(linksTo) ? linksTo : [linksTo];
            links.forEach(linkId => {
                const linkedAsset = allAssets[linkId];
                const linkName = (linkedAsset && linkedAsset.name) || linkId;
                const linkWrapper = document.createElement('div');
                const link = document.createElement('a');
                link.textContent = linkName;
                link.className = 'asset-link';
                link.onclick = (e) => {
                    e.stopPropagation();
                    showAssetDetails(linkId, findParentId(linkId));
                };
                linkWrapper.appendChild(link);
                fragment.appendChild(linkWrapper);
            });
            return fragment;
        }
        
        function renderServiceDetails(asset, parentId) {
            const container = document.createElement('div');
            container.className = 'overflow-x-auto';
            const table = document.createElement('table');
            table.className = 'min-w-full bg-white';
            const thead = table.createTHead();
            thead.innerHTML = `
                <tr class="w-full bg-gray-200 text-left text-gray-600 uppercase text-sm leading-normal">
                    <th class="py-3 px-6">Svěřená pravomoc</th>
                    <th class="py-3 px-6">Legislativa</th>
                    <th class="py-3 px-6">Agendový informační systém</th>
                </tr>
            `;
            const tbody = table.createTBody();
            tbody.className = 'text-gray-700 text-sm font-light';
            asset.details.forEach(detail => {
                const row = tbody.insertRow();
                row.className = 'border-b border-gray-200 hover:bg-gray-100';
                row.insertCell().textContent = detail.pravomoc || '-';
                row.insertCell().textContent = detail.legislativa || '-';
                const isCell = row.insertCell();
                if (detail.is && detail.is.length > 0) {
                    isCell.appendChild(createLinksFragment(detail.is));
                } else {
                    isCell.textContent = '-';
                }
            });
            container.appendChild(table);
            assetDetailContainer.appendChild(container);
        }

        function renderCheckboxList(options, checked, container, details) {
            options.forEach((option, index) => {
                const isChecked = checked[index];
                const optionDiv = document.createElement('div');
                optionDiv.className = 'flex items-center';
                
                let detailText = '';
                if (isChecked && option.toLowerCase().includes('jiné')) {
                    const detailValue = details && details[index] ? details[index] : '(neuvedeno)';
                    detailText = `<span class="ml-2 text-gray-600">- ${detailValue}</span>`;
                }

                optionDiv.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 ${isChecked ? 'text-blue-600' : 'text-gray-400'}" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        ${isChecked 
                            ? '<path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />' 
                            : '<path stroke-linecap="round" stroke-linejoin="round" d="M15 12H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z" />'
                        }
                    </svg>
                    <span>${option}</span>
                    ${detailText}
                `;
                container.appendChild(optionDiv);
            });
        }

        function renderProcessingMethods(methods, container) {
            methods.forEach(method => {
                const methodDiv = document.createElement('div');
                methodDiv.className = 'flex items-start mb-1';
                const iconAndLabel = document.createElement('div');
                iconAndLabel.className = 'flex items-center flex-shrink-0';
                iconAndLabel.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 ${method.checked ? 'text-blue-600' : 'text-gray-400'}" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                         ${method.checked 
                            ? '<path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />' 
                            : '<path stroke-linecap="round" stroke-linejoin="round" d="M15 12H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z" />'
                        }
                    </svg>
                    <span>${method.label}</span>
                `;
                methodDiv.appendChild(iconAndLabel);
                if (method.details || method.linksTo) {
                    const detailsContainer = document.createElement('div');
                    detailsContainer.className = 'ml-2 text-gray-600';
                    
                    if (method.details) {
                        const textNode = document.createTextNode(`- ${method.details}`);
                        detailsContainer.appendChild(textNode);
                    } else if (method.linksTo) {
                        detailsContainer.appendChild(createLinksFragment(method.linksTo));
                    }
                    methodDiv.appendChild(detailsContainer);
                }
                container.appendChild(methodDiv);
            });
        }
        
        function renderLawfulness(value, container) {
            const lawfulnessOptions = sharedOptions.lawfulness;
            const selectedOption = lawfulnessOptions.find(opt => opt.startsWith(value));
            
            lawfulnessOptions.forEach(option => {
                const isSelected = (option === selectedOption);
                const optionDiv = document.createElement('div');
                optionDiv.className = 'flex items-center';
                optionDiv.innerHTML = `
                     <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 ${isSelected ? 'text-blue-600' : 'text-gray-400'}" viewBox="0 0 20 20" fill="currentColor">
                        ${isSelected
                            ? '<path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />'
                            : '<path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM7 9a1 1 0 000 2h6a1 1 0 100-2H7z" clip-rule="evenodd" />'
                        }
                    </svg>
                    <span>${option}</span>
                `;
                container.appendChild(optionDiv);
            });
        }

        function renderGenericDetails(asset, assetId, changedKeys = []) {
            const detailsGrid = document.createElement('dl');
            detailsGrid.className = 'details-grid';

            if (asset.details && Object.keys(asset.details).length > 0) {
                const grandparentId = findParentId(findParentId(assetId));
                const isAgenda = grandparentId === 'agendy';
                const keysToRender = isAgenda ? detailOrder : Object.keys(asset.details).sort();

                keysToRender.forEach(key => {
                    if (asset.details[key]) {
                        const detail = asset.details[key];
                        const dt = document.createElement('dt');
                        dt.textContent = key.replace(/_/g, ' ');
                        const dd = document.createElement('dd');
                        
                        if (changedKeys.includes(key)) {
                            dd.classList.add('changed-value');
                        }
                        
                        if(detail.type === 'lawfulness') {
                            dd.textContent = sharedOptions.lawfulness.find(opt => opt.startsWith(detail.value)) || detail.value;
                        } else if (detail.type === 'processing-methods') {
                            renderProcessingMethods(detail.value, dd);
                        } else if (detail.type === 'checkbox-list' && detail.optionsKey) {
                            if (sharedOptions[detail.optionsKey] && detail.checked) {
                                renderCheckboxList(sharedOptions[detail.optionsKey], detail.checked, dd, detail.details);
                            }
                        } else if (detail.type === 'security') {
                            renderCheckboxList(sharedOptions.securityElectronic, detail.value, dd, detail.details);
                        } else if (detail.linksTo) {
                            dd.appendChild(createLinksFragment(detail.linksTo));
                        } else if (detail.type === 'dictionary' && typeof detail.value === 'object') {
                            const subList = document.createElement('ul');
                            subList.className = 'list-disc list-inside space-y-1';
                            for (const subKey in detail.value) {
                                if (detail.value.hasOwnProperty(subKey)) {
                                    const listItem = document.createElement('li');
                                    listItem.innerHTML = `<span class="font-medium capitalize">${subKey}:</span> ${detail.value[subKey]}`;
                                    subList.appendChild(listItem);
                                }
                            }
                            dd.appendChild(subList);
                        } else {
                            dd.textContent = detail.value || '-';
                        }
                        detailsGrid.appendChild(dt);
                        detailsGrid.appendChild(dd);
                    }
                });
            } else {
                 detailsGrid.innerHTML = '<p class="text-gray-500 col-span-2">Pro tuto položku nejsou k dispozici žádné podrobnosti.</p>';
            }
             assetDetailContainer.appendChild(detailsGrid);
        }

        function renderNewAgendaForm(odborId) {
            assetDetailContainer.innerHTML = '';
            const odborName = allAssets[odborId].name;

            const title = document.createElement('h2');
            title.textContent = `Nová agenda pro: ${odborName}`;
            title.className = 'text-3xl font-bold mb-6 pb-2 border-b border-gray-300';
            assetDetailContainer.appendChild(title);

            const form = document.createElement('form');
            form.id = `form-new-agenda-${odborId}`;
            form.className = 'edit-form-grid';
            
            // Pole pro název nové agendy
            const nameLabel = document.createElement('label');
            nameLabel.textContent = 'Název agendy';
            nameLabel.htmlFor = 'input-new-agenda-name';
            const nameInputContainer = document.createElement('div');
            const nameInput = document.createElement('input');
            nameInput.type = 'text';
            nameInput.id = 'input-new-agenda-name';
            nameInput.className = 'form-input';
            nameInput.required = true;
            nameInputContainer.appendChild(nameInput);
            form.appendChild(nameLabel);
            form.appendChild(nameInputContainer);

            // Vytvoření prázdné struktury pro detaily agendy
            const emptyDetails = {};
            const firstAgendaKey = Object.keys(allAssets[odborId].children)[0];
            const sampleAgenda = allAssets[firstAgendaKey];
            for (const key in sampleAgenda.details) {
                emptyDetails[key] = JSON.parse(JSON.stringify(sampleAgenda.details[key]));
                // Vynulování hodnot
                if (typeof emptyDetails[key].value === 'string') emptyDetails[key].value = '';
                if (Array.isArray(emptyDetails[key].checked)) emptyDetails[key].checked.fill(false);
                if (Array.isArray(emptyDetails[key].value)) {
                    emptyDetails[key].value.forEach(v => {
                        v.checked = false;
                        if (v.details) v.details = '';
                        if (v.linksTo) v.linksTo = [];
                    });
                }
                if (emptyDetails[key].type === 'dictionary') {
                    for(const subKey in emptyDetails[key].value) {
                        emptyDetails[key].value[subKey] = '';
                    }
                }
            }
            
            // Vykreslení formulářových polí pro detaily
            const formElements = document.createDocumentFragment();
            renderEditFormFields(formElements, 'new-agenda', emptyDetails);
            form.appendChild(formElements);
            
            assetDetailContainer.appendChild(form);
            
            // Tlačítka
            const buttonContainer = document.createElement('div');
            buttonContainer.className = 'mt-6 flex justify-end space-x-4 col-span-2';
            const saveButton = document.createElement('button');
            saveButton.textContent = 'Uložit novou agendu';
            saveButton.className = 'px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700';
            saveButton.onclick = (e) => {
                e.preventDefault();
                if (nameInput.value.trim() === '') {
                    alert('Název agendy nesmí být prázdný.');
                    return;
                }
                saveNewAgenda(odborId);
            };

            const cancelButton = document.createElement('button');
            cancelButton.textContent = 'Zrušit';
            cancelButton.className = 'px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300';
            cancelButton.onclick = (e) => {
                e.preventDefault();
                showCategoryContent(odborId);
            };
            
            buttonContainer.appendChild(cancelButton);
            buttonContainer.appendChild(saveButton);
            form.appendChild(buttonContainer);
        }

        function renderEditForm(assetId) {
            const asset = allAssets[assetId];
            assetDetailContainer.innerHTML = '';

            const title = document.createElement('h2');
            title.textContent = `Úprava: ${asset.name}`;
            title.className = 'text-3xl font-bold mb-6 pb-2 border-b border-gray-300';
            assetDetailContainer.appendChild(title);

            const form = document.createElement('form');
            form.id = `form-${assetId}`;
            form.className = 'edit-form-grid';
            
            const formElements = document.createDocumentFragment();
            
            // Pole pro název
            const nameLabel = document.createElement('label');
            nameLabel.textContent = 'Název';
            nameLabel.htmlFor = `input-${assetId}-name`;
            const nameInputContainer = document.createElement('div');
            const nameInput = document.createElement('input');
            nameInput.type = 'text';
            nameInput.id = `input-${assetId}-name`;
            nameInput.value = asset.name;
            nameInput.className = 'form-input';
            nameInputContainer.appendChild(nameInput);
            formElements.appendChild(nameLabel);
            formElements.appendChild(nameInputContainer);

            renderEditFormFields(formElements, assetId, asset.details);
            form.appendChild(formElements);
            
            assetDetailContainer.appendChild(form);
            
            // Dynamické prvky po vložení do DOM
            const zpDetail = asset.details["Způsob zpracování"];
            if (zpDetail) {
                setupLinkedSystemsSelector(assetId, zpDetail);
            }

            const buttonContainer = document.createElement('div');
            buttonContainer.className = 'mt-6 flex justify-end space-x-4 col-span-2';

            const saveButton = document.createElement('button');
            saveButton.textContent = 'Uložit';
            saveButton.className = 'px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700';
            saveButton.onclick = (e) => {
                e.preventDefault();
                saveAgendaChanges(assetId);
            };

            const cancelButton = document.createElement('button');
            cancelButton.textContent = 'Zrušit';
            cancelButton.className = 'px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300';
            cancelButton.onclick = (e) => {
                e.preventDefault();
                showAssetDetails(assetId, findParentId(assetId));
            };
            
            buttonContainer.appendChild(cancelButton);
            buttonContainer.appendChild(saveButton);
            form.appendChild(buttonContainer);
        }
        
        function renderSupportAssetEditForm(assetId) {
            const asset = allAssets[assetId];
            const assetPath = getPathForAsset(assetId);
            assetDetailContainer.innerHTML = '';

            const title = document.createElement('h2');
            title.textContent = `Úprava: ${asset.name}`;
            title.className = 'text-3xl font-bold mb-6 pb-2 border-b border-gray-300';
            assetDetailContainer.appendChild(title);

            const form = document.createElement('form');
            form.id = `form-${assetId}`;
            form.className = 'edit-form-grid';

            // Pole pro název
            const nameLabel = document.createElement('label');
            nameLabel.textContent = 'Název';
            nameLabel.htmlFor = `input-${assetId}-name`;
            const nameInputContainer = document.createElement('div');
            const nameInput = document.createElement('input');
            nameInput.type = 'text';
            nameInput.id = `input-${assetId}-name`;
            nameInput.value = asset.name;
            nameInput.className = 'form-input';
            nameInputContainer.appendChild(nameInput);
            form.appendChild(nameLabel);
            form.appendChild(nameInputContainer);

            for (const key in asset.details) {
                const detail = asset.details[key];
                const label = document.createElement('label');
                label.textContent = key.replace(/_/g, ' ');
                const inputContainer = document.createElement('div');

                if (detail.linksTo) {
                    const selectedItemsContainer = document.createElement('div');
                    selectedItemsContainer.id = `selected-items-${key}`;
                    selectedItemsContainer.className = 'flex flex-wrap items-center mb-2';

                    const currentLinks = Array.isArray(detail.linksTo) ? detail.linksTo : (detail.linksTo ? [detail.linksTo] : []);

                    const updateDropdown = (selectEl, currentSelection) => {
                        const assetCategoryPath = Object.keys(reciprocalMap).find(p => assetPath.startsWith(p));
                        const linkConfig = reciprocalMap[assetCategoryPath]?.[key];
                        if (!linkConfig) return;
                        
                        const targetCategory = getObjectByPath(assetData, linkConfig.targetCategoryPath);
                        selectEl.innerHTML = '<option value="">Vyberte položku...</option>';

                        for (const targetId in targetCategory.children) {
                            if (!currentSelection.includes(targetId)) {
                                const option = document.createElement('option');
                                option.value = targetId;
                                option.textContent = targetCategory.children[targetId].name;
                                selectEl.appendChild(option);
                            }
                        }
                    };
                    
                    const addSelectedItem = (id, name) => {
                        const badge = document.createElement('span');
                        badge.className = 'selected-item-badge';
                        badge.dataset.id = id;
                        badge.textContent = name;
                        
                        const removeBtn = document.createElement('button');
                        removeBtn.innerHTML = '&times;';
                        removeBtn.type = 'button';
                        removeBtn.onclick = () => {
                            badge.remove();
                            const currentSelection = Array.from(selectedItemsContainer.children).map(b => b.dataset.id);
                            updateDropdown(select, currentSelection);
                        };
                        badge.appendChild(removeBtn);
                        selectedItemsContainer.appendChild(badge);
                    };
                    
                    currentLinks.forEach(linkId => {
                        if (allAssets[linkId]) {
                            addSelectedItem(linkId, allAssets[linkId].name);
                        }
                    });

                    const addWrapper = document.createElement('div');
                    addWrapper.className = 'flex items-center space-x-2';
                    const select = document.createElement('select');
                    select.className = 'form-input';
                    
                    const addButton = document.createElement('button');
                    addButton.textContent = 'Přidat';
                    addButton.type = 'button';
                    addButton.className = 'px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600';
                    addButton.onclick = () => {
                        const selectedId = select.value;
                        if (!selectedId) return;
                        addSelectedItem(selectedId, allAssets[selectedId].name);
                        const currentSelection = Array.from(selectedItemsContainer.children).map(b => b.dataset.id);
                        updateDropdown(select, currentSelection);
                    };

                    updateDropdown(select, currentLinks);
                    addWrapper.appendChild(select);
                    addWrapper.appendChild(addButton);
                    inputContainer.appendChild(selectedItemsContainer);
                    inputContainer.appendChild(addWrapper);

                } else {
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.id = `input-${key}`;
                    input.value = detail.value || '';
                    input.className = 'form-input';
                    inputContainer.appendChild(input);
                }

                form.appendChild(label);
                form.appendChild(inputContainer);
            }

            const buttonContainer = document.createElement('div');
            buttonContainer.className = 'mt-6 flex justify-end space-x-4 col-span-2';

            const saveButton = document.createElement('button');
            saveButton.textContent = 'Uložit';
            saveButton.className = 'px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700';
            saveButton.onclick = (e) => {
                e.preventDefault();
                saveSupportAssetChanges(assetId);
            };

            const cancelButton = document.createElement('button');
            cancelButton.textContent = 'Zrušit';
            cancelButton.className = 'px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300';
            cancelButton.onclick = (e) => {
                e.preventDefault();
                showAssetDetails(assetId, findParentId(assetId));
            };
            
            buttonContainer.appendChild(cancelButton);
            buttonContainer.appendChild(saveButton);
            form.appendChild(buttonContainer);
            assetDetailContainer.appendChild(form);
        }

        async function saveNewAgenda(odborId) {
            const form = document.getElementById(`form-new-agenda-${odborId}`);
            const newNameInput = form.querySelector('#input-new-agenda-name');
            const newName = newNameInput.value.trim();

            if (!newName) {
                alert('Název agendy je povinný.');
                return;
            }

            // Vytvoření unikátního ID pro novou agendu (např. z názvu a časového razítka)
            const newAgendaId = `${odborId}-${sanitizeForId(newName.toLowerCase())}-${Date.now()}`;
            
            const newAgendaData = {
                name: newName,
                details: {}
            };

            // Získání dat z formuláře (podobně jako v saveAgendaChanges)
            const firstAgendaKey = Object.keys(allAssets[odborId].children)[0];
            const sampleDetails = allAssets[firstAgendaKey].details;

            for (const key in sampleDetails) {
                const detailTemplate = sampleDetails[key];
                const sanitizedKey = sanitizeForId(key);
                const newDetail = JSON.parse(JSON.stringify(detailTemplate));

                // Zpracování různých typů polí
                if (key === "Lhůty pro výmaz" && newDetail.type === 'dictionary') {
                    for (const subKey in newDetail.value) {
                        const input = form.querySelector(`#input-new-agenda-${sanitizedKey}-${sanitizeForId(subKey)}`);
                        newDetail.value[subKey] = input ? input.value : '';
                    }
                } else if (key === "Způsob zpracování") {
                    newDetail.value.forEach((method, methodIndex) => {
                        const checkbox = form.querySelector(`#input-new-agenda-${sanitizedKey}-${methodIndex}`);
                        method.checked = checkbox ? checkbox.checked : false;
                        if (method.checked) {
                            if (method.details !== undefined) {
                                const detailsInput = form.querySelector(`#input-new-agenda-${sanitizedKey}-${methodIndex}-details`);
                                method.details = detailsInput ? detailsInput.value : '';
                            }
                        } else {
                            if (method.details !== undefined) method.details = '';
                            if (method.linksTo !== undefined) method.linksTo = [];
                        }
                    });
                } else if ((newDetail.type === 'checkbox-list' && newDetail.optionsKey) || newDetail.type === 'security') {
                    const optionsKey = newDetail.optionsKey || (key.includes('elektronické') ? 'securityElectronic' : 'securityAnalog');
                    newDetail.checked = [];
                    newDetail.details = {};
                    sharedOptions[optionsKey].forEach((option, index) => {
                        const checkboxId = `input-new-agenda-${sanitizedKey}-${index}`;
                        const checkbox = form.querySelector(`#${checkboxId}`);
                        const isChecked = checkbox ? checkbox.checked : false;
                        newDetail.checked.push(isChecked);

                        if (option.toLowerCase().includes('jiné') && isChecked) {
                            const detailsInput = form.querySelector(`#${checkboxId}-details`);
                            newDetail.details[index] = detailsInput ? detailsInput.value : 'neuvedeno';
                        }
                    });
                } else if (newDetail.type === 'lawfulness') {
                    const select = form.querySelector(`#input-new-agenda-${sanitizedKey}`);
                    newDetail.value = select ? select.value : '';
                } else if (typeof newDetail.value === 'string') {
                    const input = form.querySelector(`#input-new-agenda-${sanitizedKey}`);
                    newDetail.value = input ? input.value : '';
                }
                newAgendaData.details[key] = newDetail;
            }

            const idToken = await currentUser.getIdToken();
            try {
                const response = await fetch('/.netlify/functions/create-agenda', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${idToken}` },
                    body: JSON.stringify({ odborId, newAgendaId, newAgendaData })
                });
                if (!response.ok) throw new Error(await response.text());

                await loadInitialData();
                showCategoryContent(odborId);

            } catch (error) {
                console.error('Chyba při vytváření nové agendy:', error);
                alert('Nepodařilo se vytvořit novou agendu.');
            }
        }

        async function saveAgendaChanges(assetId) {
            const asset = allAssets[assetId];
            const form = document.getElementById(`form-${assetId}`);
            const changedKeys = [];
            const updatedDetails = JSON.parse(JSON.stringify(asset.details)); 

            const newNameInput = form.querySelector(`#input-${assetId}-name`);
            const newName = newNameInput.value.trim();
            if (newName !== asset.name) {
                changedKeys.push('name');
            }

            for (const key in updatedDetails) {
                const detail = updatedDetails[key];
                const sanitizedKey = sanitizeForId(key);
                
                if (key === "Lhůty pro výmaz" && detail.type === 'dictionary') {
                    let changed = false;
                    const newLhutyValue = {};
                    for (const subKey in detail.value) {
                        const inputId = `input-${assetId}-${sanitizedKey}-${sanitizeForId(subKey)}`;
                        const input = form.querySelector(`#${inputId}`);
                        if (input && detail.value[subKey] !== input.value) {
                            changed = true;
                        }
                        newLhutyValue[subKey] = input.value;
                    }

                    if (changed) {
                        updatedDetails[key].value = newLhutyValue;
                        if (!changedKeys.includes(key)) changedKeys.push(key);
                    }
                }
                else if (key === "Způsob zpracování") {
                    const originalMethods = asset.details[key].value;
                    const newMethods = [];

                    originalMethods.forEach((method, methodIndex) => {
                        const newMethod = { ...method };
                        const checkbox = form.querySelector(`#input-${assetId}-${sanitizedKey}-${methodIndex}`);
                        if (!checkbox) return;

                        const isNowChecked = checkbox.checked;
                        newMethod.checked = isNowChecked;

                        if (isNowChecked) {
                            if (method.label.includes("agendový informační systém")) {
                                const linkedContainer = document.getElementById(`linked-systems-${assetId}`);
                                newMethod.linksTo = Array.from(linkedContainer.children).map(div => div.dataset.systemId);
                            } else if (method.details !== undefined) {
                                const detailsInput = form.querySelector(`#input-${assetId}-${sanitizedKey}-${methodIndex}-details`);
                                newMethod.details = detailsInput ? detailsInput.value : '';
                            }
                        } else {
                            if (method.details !== undefined) newMethod.details = "";
                            if (method.linksTo !== undefined) newMethod.linksTo = [];
                        }
                        newMethods.push(newMethod);
                    });
                    
                    if (JSON.stringify(originalMethods) !== JSON.stringify(newMethods)) {
                       updatedDetails[key].value = newMethods;
                       if (!changedKeys.includes(key)) changedKeys.push(key);
                    }
                }
                else if ((detail.type === 'checkbox-list' && detail.optionsKey) || detail.type === 'security') {
                    const originalDetail = asset.details[key];
                    const newChecked = [];
                    const newDetails = {};
                    const optionsKey = detail.optionsKey || (key.includes('elektronické') ? 'securityElectronic' : 'securityAnalog');
                    
                    sharedOptions[optionsKey].forEach((option, index) => {
                        const checkboxId = `input-${assetId}-${sanitizedKey}-${index}`;
                        const checkbox = form.querySelector(`#${checkboxId}`);
                        if (checkbox) {
                            newChecked.push(checkbox.checked);
                            if (option.toLowerCase().includes('jiné') && checkbox.checked) {
                                const detailsInput = form.querySelector(`#${checkboxId}-details`);
                                newDetails[index] = detailsInput ? detailsInput.value : 'neuvedeno';
                            }
                        }
                    });

                    if (JSON.stringify(originalDetail.checked || originalDetail.value) !== JSON.stringify(newChecked) || JSON.stringify(originalDetail.details || {}) !== JSON.stringify(newDetails)) {
                        if(detail.checked) {
                            updatedDetails[key].checked = newChecked;
                        } else {
                            updatedDetails[key].value = newChecked;
                        }
                        updatedDetails[key].details = newDetails;
                        if (!changedKeys.includes(key)) changedKeys.push(key);
                    }
                } else if (detail.type === 'lawfulness') {
                    const select = form.querySelector(`#input-${assetId}-${sanitizedKey}`);
                    if (select && detail.value !== select.value) {
                        updatedDetails[key].value = select.value;
                        if (!changedKeys.includes(key)) changedKeys.push(key);
                    }
                } else if (detail.value !== undefined && typeof detail.value === 'string') {
                    const input = form.querySelector(`#input-${assetId}-${sanitizedKey}`);
                    if (input && detail.value !== input.value) {
                        updatedDetails[key].value = input.value;
                        if (!changedKeys.includes(key)) changedKeys.push(key);
                    }
                }
            }
            
            if (changedKeys.length > 0) {
                const parentId = findParentId(assetId);
                const agendaPath = `agendy/children/${parentId}/children/${assetId}`;
                const idToken = await currentUser.getIdToken();
                
                const originalAisMethod = asset.details["Způsob zpracování"]?.value.find(m => m.label.includes("agendový"));
                const updatedAisMethod = updatedDetails["Způsob zpracování"]?.value.find(m => m.label.includes("agendový"));
                const originalLinks = originalAisMethod?.linksTo?.slice() || [];
                const newLinks = updatedAisMethod?.linksTo?.slice() || [];

                const linksToAdd = newLinks.filter(id => !originalLinks.includes(id));
                const linksToRemove = originalLinks.filter(id => !newLinks.includes(id));

                try {
                    const response = await fetch('/.netlify/functions/update-agenda', {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${idToken}` },
                        body: JSON.stringify({ 
                            agendaPath, 
                            newName: (newName !== asset.name ? newName : null),
                            updatedAgendaDetails: updatedDetails,
                            linksToAdd,
                            linksToRemove,
                            agendaId: assetId
                        })
                    });
                    if (!response.ok) throw new Error(await response.text());

                    await loadInitialData();
                    showAssetDetails(assetId, parentId, changedKeys);
                } catch (error) {
                    console.error('Chyba při ukládání změn agendy:', error);
                    alert('Nepodařilo se uložit změny. Zkontrolujte svá oprávnění.');
                }
            } else {
                showAssetDetails(assetId, findParentId(assetId));
            }
        }


        async function saveSupportAssetChanges(assetId) {
            const asset = allAssets[assetId];
            const form = document.getElementById(`form-${assetId}`);
            const updatedDetails = JSON.parse(JSON.stringify(asset.details));
            let hasChanged = false;
            
            const newNameInput = form.querySelector(`#input-${assetId}-name`);
            const newName = newNameInput.value.trim();
            if (newName !== asset.name) {
                hasChanged = true;
            }

            const reciprocalLinks = { toAdd: [], toRemove: [] };
            const assetPath = getPathForAsset(assetId);

            for (const key in updatedDetails) {
                const detail = updatedDetails[key];
                
                if (detail.linksTo) {
                    const selectedItemsContainer = form.querySelector(`#selected-items-${key}`);
                    const newLinks = Array.from(selectedItemsContainer.children).map(badge => badge.dataset.id);
                    const originalLinks = Array.isArray(detail.linksTo) ? (detail.linksTo.length === 1 && detail.linksTo[0] === "" ? [] : detail.linksTo) : [];

                    if (JSON.stringify(newLinks.sort()) !== JSON.stringify(originalLinks.sort())) {
                        hasChanged = true;
                        updatedDetails[key].linksTo = newLinks;

                        const assetCategoryPath = Object.keys(reciprocalMap).find(p => assetPath.startsWith(p));
                        const linkConfig = reciprocalMap[assetCategoryPath]?.[key.replace(/ /g, '_')];
                        
                        if (linkConfig) {
                            const toAdd = newLinks.filter(id => !originalLinks.includes(id));
                            const toRemove = originalLinks.filter(id => !newLinks.includes(id));

                            toAdd.forEach(targetId => {
                                reciprocalLinks.toAdd.push({
                                    targetPath: `${linkConfig.targetCategoryPath}/children/${targetId}/details/${linkConfig.reciprocalField}/linksTo`,
                                    sourceId: assetId
                                });
                            });
                            toRemove.forEach(targetId => {
                                reciprocalLinks.toRemove.push({
                                    targetPath: `${linkConfig.targetCategoryPath}/children/${targetId}/details/${linkConfig.reciprocalField}/linksTo`,
                                    sourceId: assetId
                                });
                            });
                        }
                    }
                } else {
                    const input = form.querySelector(`#input-${key}`);
                    if (input && input.value !== detail.value) {
                        hasChanged = true;
                        updatedDetails[key].value = input.value;
                    }
                }
            }

            if (hasChanged) {
                const idToken = await currentUser.getIdToken();
                try {
                    const response = await fetch('/.netlify/functions/update-support-asset', {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${idToken}` },
                        body: JSON.stringify({ assetPath, newName: (newName !== asset.name ? newName : null), updatedDetails, reciprocalLinks })
                    });
                    if (!response.ok) throw new Error(await response.text());
                    
                    await loadInitialData();
                    showAssetDetails(assetId, findParentId(assetId));

                } catch (error) {
                    console.error('Chyba při ukládání změn podpůrného aktiva:', error);
                    alert('Nepodařilo se uložit změny. Zkontrolujte svá oprávnění.');
                }
            } else {
                showAssetDetails(assetId, findParentId(assetId));
            }
        }
        
        function showAssetDetails(assetId, parentId, changedKeys = []) {
            const asset = allAssets[assetId];
            if (!asset) return;
            welcomeMessage.classList.add('hidden');
            assetDetailContainer.classList.remove('hidden');
            assetDetailContainer.innerHTML = '';
            document.querySelectorAll('.sidebar-item.active').forEach(el => el.classList.remove('active'));
            if (parentId) {
               document.querySelector(`.sidebar-item[data-id="${parentId}"]`)?.classList.add('active');
            }
            if (parentId && allAssets[parentId]) {
                const parentAsset = allAssets[parentId];
                const breadcrumbs = document.createElement('div');
                breadcrumbs.className = 'mb-4 text-sm';

                const parentLink = document.createElement('a');
                parentLink.className = 'asset-link';
                parentLink.textContent = parentAsset.name;
                parentLink.onclick = (e) => {
                    e.stopPropagation();
                    showCategoryContent(parentId);
                };
                
                const separator = document.createElement('span');
                separator.className = 'mx-2 text-gray-400';
                separator.textContent = '/';
                
                const currentAssetText = document.createElement('span');
                currentAssetText.className = 'text-gray-600';
                currentAssetText.textContent = asset.name;

                breadcrumbs.appendChild(parentLink);
                breadcrumbs.appendChild(separator);
                breadcrumbs.appendChild(currentAssetText);
                assetDetailContainer.appendChild(breadcrumbs);
            }
            const titleContainer = document.createElement('div');
            titleContainer.className = 'flex justify-between items-center border-b border-gray-300 mb-6 pb-2';
            const title = document.createElement('h2');
            title.textContent = asset.name;
            title.className = 'text-3xl font-bold';
            titleContainer.appendChild(title);

            const grandparentId = findParentId(parentId);
            const isAgenda = grandparentId === 'agendy';
            const isSupportOrPrimary = grandparentId === 'podpurna' || grandparentId === 'primarni';

            let canEdit = false;
            if (isAgenda && (userRole === 'administrator' || (userRole === 'garant' && userOdbor === parentId))) {
                canEdit = true;
            } else if (isSupportOrPrimary && userRole === 'administrator') {
                canEdit = true;
            }

            if (canEdit) {
                const editButton = document.createElement('button');
                editButton.textContent = 'Upravit';
                editButton.className = 'px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300';
                if (isAgenda) {
                    editButton.onclick = () => renderEditForm(assetId);
                } else {
                    editButton.onclick = () => renderSupportAssetEditForm(assetId);
                }
                titleContainer.appendChild(editButton);
            }
            assetDetailContainer.appendChild(titleContainer);

            if (asset.type === 'sluzba-uradu') {
                renderServiceDetails(asset, parentId);
            } else {
                renderGenericDetails(asset, assetId, changedKeys);
            }
        }
        
        async function loadInitialData() {
             try {
                const response = await fetch('/.netlify/functions/get-data');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();

                if (!data || !data.primarni || !data.podpurna || !data.agendy || !data.options) {
                    throw new Error("Načtená data nemají správnou strukturu.");
                }

                assetData = {
                    primarni: data.primarni,
                    podpurna: data.podpurna,
                    agendy: data.agendy
                };
                sharedOptions = data.options;
                
                allAssets = flattenData(assetData);
                buildParentMap(assetData);
                
                sidebar.innerHTML = ''; 
                buildNav(assetData, sidebar);

                welcomeMessage.querySelector('h2').textContent = 'Vítejte v evidenci aktiv';
                welcomeMessage.querySelector('p').textContent = 'Vyberte položku z menu vlevo pro zobrazení detailů.';

            } catch (error) {
                console.error('Chyba při načítání dat:', error);
                welcomeMessage.querySelector('h2').textContent = 'Chyba při načítání dat';
                welcomeMessage.querySelector('p').textContent = 'Zkuste prosím obnovit stránku. Chyba: ' + error.message;
            }
        }
    </script>
</body>
</html>
