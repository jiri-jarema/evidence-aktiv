<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evidence aktiv - MěÚ Vítkov</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* ... (styly zůstávají stejné) ... */
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="flex flex-col h-screen">
        <!-- Header -->
        <header class="bg-white shadow-md w-full p-4">
            <h1 class="text-2xl font-bold text-gray-700">Evidence aktiv Městského úřadu Vítkov</h1>
        </header>

        <!-- Main Content -->
        <div class="flex flex-1 overflow-hidden">
            <!-- Sidebar -->
            <nav id="sidebar" class="w-1/3 lg:w-1/4 bg-white border-r border-gray-200 overflow-y-auto p-4">
                <!-- Navigation will be generated here -->
            </nav>

            <!-- Content -->
            <main id="content" class="flex-1 p-6 overflow-y-auto">
                 <div class="bg-white p-4 rounded-lg shadow-md mb-6">
                    <dl class="details-grid">
                        <dt>Správce:</dt>
                        <dd>Město Vítkov, náměstí Jana Zajíce 7, 749 01 Vítkov, IČO: 00300870</dd>
                        <dt>Pověřenec:</dt>
                        <dd>Mgr. Jiří Jarema, poverenec.vitkov@outlook.cz, tel.: 775 248 345</dd>
                    </dl>
                </div>

                <div id="welcome-message" class="text-center text-gray-500">
                    <h2 class="text-2xl font-semibold mb-2">Načítám data...</h2>
                </div>
                <div id="asset-detail" class="hidden">
                    <!-- Asset details will be rendered here -->
                </div>
            </main>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            let assetData = {};
            let sharedOptions = {};
            let allAssets = {};
            let parentMap = {};

            const sidebar = document.getElementById('sidebar');
            const assetDetailContainer = document.getElementById('asset-detail');
            const welcomeMessage = document.getElementById('welcome-message');

            try {
                const response = await fetch('/.netlify/functions/get-data');
                const data = await response.json();
                assetData = {
                    primarni: data.primarni,
                    podpurna: data.podpurna,
                    agendy: data.agendy
                };
                sharedOptions = data.options;
                
                allAssets = flattenData(assetData);
                buildParentMap(assetData);
                buildNav(assetData, sidebar);
                welcomeMessage.querySelector('h2').textContent = 'Vítejte v evidenci aktiv';
                welcomeMessage.querySelector('p').textContent = 'Vyberte položku z menu vlevo pro zobrazení detailů.';

            } catch (error) {
                console.error('Chyba při načítání dat:', error);
                welcomeMessage.querySelector('h2').textContent = 'Chyba při načítání dat';
                welcomeMessage.querySelector('p').textContent = 'Zkuste prosím obnovit stránku.';
            }
            
            // ... (všechny ostatní funkce jako flattenData, buildNav, atd. zůstávají stejné)

            async function saveChanges(assetId) {
                const asset = allAssets[assetId];
                const form = document.getElementById(`form-${assetId}`);
                const changedKeys = [];
                const updatedDetails = JSON.parse(JSON.stringify(asset.details)); 

                for (const key in updatedDetails) {
                    const detail = updatedDetails[key];
                    if ((detail.type === 'checkbox-list' && detail.optionsKey) || detail.type === 'security') {
                        let changed = false;
                        const checkedArray = detail.checked || detail.value;
                        const newChecked = [];
                        const optionsKey = detail.optionsKey || (key.includes('elektronické') ? 'securityElectronic' : 'securityAnalog');
                        
                        sharedOptions[optionsKey].forEach((_, index) => {
                            const checkbox = form.querySelector(`#input-${assetId}-${key}-${index}`);
                            if (checkbox) {
                                if (checkedArray[index] !== checkbox.checked) {
                                    changed = true;
                                }
                                newChecked.push(checkbox.checked);
                            }
                        });

                        if (changed) {
                            if(detail.checked) {
                                updatedDetails[key].checked = newChecked;
                            } else {
                                updatedDetails[key].value = newChecked;
                            }
                            changedKeys.push(key);
                        }
                    } else if (detail.type === 'lawfulness') {
                        const select = form.querySelector(`#input-${assetId}-${key}`);
                        if (select && detail.value !== select.value) {
                            updatedDetails[key].value = select.value;
                            changedKeys.push(key);
                        }
                    } else if (detail.value !== undefined && typeof detail.value === 'string') {
                        const input = form.querySelector(`#input-${assetId}-${key}`);
                        if (input && detail.value !== input.value) {
                            updatedDetails[key].value = input.value;
                            changedKeys.push(key);
                        }
                    }
                }
                
                if (changedKeys.length > 0) {
                    const parentId = findParentId(assetId);
                    const grandparentId = findParentId(parentId);
                    const path = `agendy/children/${parentId}/children/${assetId}/details`;
                    
                    try {
                        await fetch('/.netlify/functions/update-agenda', {
                            method: 'POST',
                            body: JSON.stringify({ path, data: updatedDetails })
                        });
                        asset.details = updatedDetails;
                        showAssetDetails(assetId, parentId, changedKeys);
                    } catch (error) {
                        console.error('Chyba při ukládání změn:', error);
                        alert('Nepodařilo se uložit změny.');
                    }
                } else {
                    showAssetDetails(assetId, findParentId(assetId));
                }
            }

            // ... (zde budou všechny ostatní funkce pro renderování, které zůstávají stejné)
        });
    </script>
</body>
</html>
